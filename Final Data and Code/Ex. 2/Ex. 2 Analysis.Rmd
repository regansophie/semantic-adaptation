---
title: "Ex. 2 Analysis"
output: html_document
date: "2023-11-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(boot)
library(ggthemes)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lme4)
```

```{r}
#reading in the data
data.many_csv <- read.csv("Study 3 (Study 2 Rep) Final Data - Many Condition.csv")
data.some_csv <- read.csv("Study 3 (Study 2 Rep) Final Data - Some Condition.csv")
```

Bootstrap functions
```{r}
ci.low <- function(x, R = 2000, conf = 0.95) {
  boot_mean <- function(data, idx) mean(data[idx], na.rm = TRUE)
  b <- boot(x, boot_mean, R = R)
  qs <- quantile(b$t, probs = (1 - conf) / 2, names = FALSE, type = 7)
  mean(x) - qs
}

ci.high <- function(x, R = 2000, conf = 0.95) {
  boot_mean <- function(data, idx) mean(data[idx], na.rm = TRUE)
  b <- boot(x, boot_mean, R = R)
  qs <- quantile(b$t, probs = 1 - (1 - conf) / 2, names = FALSE, type = 7)
  qs - mean(x)
}
```

```{r}
data.many <- data.many_csv %>% pivot_longer(c(-Subject.ID, -Age, -Gender, -Order))

data.many$condition = "many"

#adding a column for number of candies and phase
data.post.many <- data.many %>% filter(grepl("^X",name))
data.post.many <- data.post.many %>% mutate(nCandies = sub("X([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.post.many$phase <- "post"

data.pre.many <- data.many %>% filter(grepl("^PE.[0-9]",name))
data.pre.many <- data.pre.many %>% mutate(nCandies = sub("PE.([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.pre.many$phase <- "pre"

#adding numeric values: 1 if response is many, 0 if response is some; filter out any other response
data.many.full <- rbind(data.pre.many,data.post.many)
data.many.full <- data.many.full %>% mutate(num_response = case_when(value=="many"~1, value == "some"~0))
data.many.full <- data.many.full %>% filter(!is.na(num_response))

#finding means and confidence intervals
many_condition_means <- data.many.full %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(subject_mean = mean(num_response)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean= mean(subject_mean),
         ci_high = mean+ ci.high(subject_mean), 
         ci_low = mean- ci.low(subject_mean)
         )
  
many_condition_means$condition <- "Many-biased Condition"
```


```{r}
data.some <- data.some_csv %>% pivot_longer(c(-Subject.ID, -Age, -Gender, -Order))
data.some $condition = "some"

#adding a column for number of candies and phase
data.post.some <- data.some %>% filter(grepl("^X",name))
data.post.some <- data.post.some %>% mutate(nCandies = sub("X([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.post.some$phase <- "post"

data.pre.some <- data.some %>% filter(grepl("^PE.[0-9]",name))
data.pre.some <- data.pre.some %>% mutate(nCandies = sub("PE.([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.pre.some$phase <- "pre"


data.some.full <- rbind(data.pre.some,data.post.some)

#adding numeric values: 1 if response is many, 0 if response is some; filter out any other response
data.some.full <- data.some.full %>% mutate(num_response = case_when(value == "many"~1, value == "some" ~0))
data.some.full <- data.some.full %>% filter(!is.na(num_response))

#combining many condition data and some condition data
data_total <- rbind(data.some.full, data.many.full)

#centering number of candies
data_total$n_centered <- data_total$nCandies-5


#finding means and confidence intervals
some_condition_means <- data.some.full %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(subj_mean = mean(num_response)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean = mean(subj_mean),
         ci_high = mean + ci.high(subj_mean), 
         ci_low = mean - ci.low(subj_mean)
         )


#creating a data frame to plot both the change in some responses and many responses (change in some and many are basically mirror image after removing "other" responses, so it is not super informative, but it makes a nice looking plot)
data.some.full_some <- data.some.full %>% mutate(num_response_reversed = case_when(num_response == 0 ~ 1,
                                                                                   .default = 0))
some_condition_means_some = data.some.full_some %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(participant_mean = mean(num_response_reversed)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean= mean(participant_mean),
         ci_high = mean+ ci.high(participant_mean), 
         ci_low = mean- ci.low(participant_mean)
         )
  
some_condition_means_some$response <- "some"
some_condition_means$response <- "many"
some_condition_means_some$condition <- "Some-biased Condition"
some_condition_means$condition <- "Some-biased Condition"
some_total <- rbind(some_condition_means_some, some_condition_means)

data.many.full_some <- data.many.full %>% mutate(num_response_reversed = case_when(num_response == 0 ~ 1,
                                                                                   .default = 0))
many_condition_means_some = data.many.full_some %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(participant_mean = mean(num_response_reversed)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean = mean(participant_mean),
         ci_high = mean + ci.high(participant_mean), 
         ci_low = mean - ci.low(participant_mean)
         )

many_condition_means_some$response <- "some"
many_condition_means$response <- "many"
many_total <- rbind(many_condition_means_some, many_condition_means)
many_total$condition <- "Many-biased Condition"

total_means_many <- rbind(many_condition_means, some_condition_means)
total_means <- rbind(some_total, many_total)
```

# Making the Final Plot
```{r}
total_means$response <- factor(
  stringr::str_to_title(total_means$response),  # Capitalize: Some, Many
  levels = c("Some", "Many")  # Ensure Some comes before Many
)

total_means$phase <- factor(
  total_means$phase,
  levels = c("pre", "post"),  # Original order
  labels = c("Pre-Exposure Phase", "Post-Exposure Phase")  # New labels
)

total_means$condition <- factor(
  total_means$condition,
  levels = c("Some-biased Condition", "Many-biased Condition")
)

ggplot(total_means, aes(
  x = nCandies, y = mean,
  color = condition,
  linetype = response,
  group = interaction(condition, response)
)) +
  geom_line(
    position = position_dodge(width = 0.3),
    linewidth = 1
  ) +
  geom_pointrange(
    aes(ymin = ci_low, ymax = ci_high),
    position = position_dodge(width = 0.3),
    shape = 16,
    size = 1.5,
    fatten = 1.5,
    show.legend = FALSE  
  ) +
  facet_wrap(~phase) +
  labs(
    x = "Number of Candies out of 10",
    y = "Proportion of Each Choice",
    color = "Condition",
    linetype = "Response"
  ) +
  ylim(0, 1) +
  ggthemes::theme_few(base_size = 14) +
  theme(
    text = element_text(family = "Arial"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.title = element_text(face = "bold"),
    legend.position = "right",
    strip.text = element_text(size = 16, face = "bold")
  )


ggsave("ex. 2 final plot 1.0.png", width = 14, height = 7)
```


```{r}
#pre-registered model
prepost_model <- glmer(num_response ~ n_centered * condition * phase  + (1 | Subject.ID), 
      data = data_total, 
      family = "binomial")

summary(prepost_model)
```


There doesn't seem to be much of an effect in the "some" condition, but maybe this is because for 5/10 candies, participants were already expecting the speaker to say "some" (>80%), so the exposure did not provide any new information. Below, I repeat the above analysis and recreate the plots, but I remove any participant who exclusively answered "some" for 5/10 (aka anyone who was already at ceiling so could not have adapted for the target proportion).
```{r}
data_many_exlude_ceiling <- data.many_csv %>% filter(PE.5 == "some" | PE.5.1 == "some" | PE.5.2 == "some")

data_many_exlude_ceiling <- data_many_exlude_ceiling %>% pivot_longer(c(-Subject.ID, -Age, -Gender, -Order))


data_many_exlude_ceiling$condition = "many"

#adding a column for number of candies and phase
data.post.many <- data_many_exlude_ceiling %>% filter(grepl("^X",name))
data.post.many <- data.post.many %>% mutate(nCandies = sub("X([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.post.many$phase <- "post"

data.pre.many <- data_many_exlude_ceiling %>% filter(grepl("^PE.[0-9]",name))
data.pre.many <- data.pre.many %>% mutate(nCandies = sub("PE.([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.pre.many$phase <- "pre"

#adding numeric values: 1 if response is many, 0 if response is some; filter out any other response
data.many.full <- rbind(data.pre.many,data.post.many)
data.many.full <- data.many.full %>% mutate(num_response = case_when(value=="many"~1, value == "some"~0))
data.many.full <- data.many.full %>% filter(!is.na(num_response))

#finding means and confidence intervals
many_condition_means <- data.many.full %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(subject_mean = mean(num_response)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean= mean(subject_mean),
         ci_high = mean+ ci.high(subject_mean), 
         ci_low = mean- ci.low(subject_mean)
         )
  
many_condition_means$condition <- "many"
```


```{r}
data_some_exlude_ceiling <- data.some_csv %>% filter(PE.5 == "many" | PE.5.1 == "many" | PE.5.2 == "many")

data_some_exlude_ceiling <- data_some_exlude_ceiling %>% pivot_longer(c(-Subject.ID, -Age, -Gender, -Order))

data_some_exlude_ceiling$condition = "some"

#adding a column for number of candies and phase
data.post.some <- data_some_exlude_ceiling %>% filter(grepl("^X",name))
data.post.some <- data.post.some %>% mutate(nCandies = sub("X([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.post.some$phase <- "post"

data.pre.some <- data_some_exlude_ceiling %>% filter(grepl("^PE.[0-9]",name))
data.pre.some <- data.pre.some %>% mutate(nCandies = sub("PE.([0-9]).*", "\\1", name, perl = TRUE)) %>% mutate(nCandies=as.numeric(nCandies))
data.pre.some$phase <- "pre"

#adding numeric values: 1 if response is many, 0 if response is some; filter out any other response
data.some.full <- rbind(data.pre.some,data.post.some)
data.some.full <- data.some.full %>% mutate(num_response = case_when(value=="many"~1, value == "some"~0))
data.some.full <- data.some.full %>% filter(!is.na(num_response))

#finding means and confidence intervals
some_condition_means <- data.some.full %>%
  group_by(Subject.ID, phase, nCandies) %>% 
  summarise(subject_mean = mean(num_response)) %>%
  group_by(phase, nCandies) %>%
  summarise(mean= mean(subject_mean),
         ci_high = mean+ ci.high(subject_mean), 
         ci_low = mean- ci.low(subject_mean)
         )
  
some_condition_means$condition <- "some"

total_exclusion_data <- rbind(data.some.full, data.many.full)
```

Re-running the model with the trimmed data
```{r}
total_exclusion_data$n_centered <- total_exclusion_data$nCandies-5

excluded_model <- glmer(num_response ~ n_centered * condition * phase  + (1 | Subject.ID), 
      data = total_exclusion_data, 
      family = "binomial")

summary(excluded_model)
```



